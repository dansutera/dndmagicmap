<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Basics -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MagicMap</title>
    <link rel="shortcut icon" href="./favicon.png">

    <!-- For Facebook / Opengraph -->
    <meta property="og:title" content="Magic Map" />
    <meta property="og:type" content="website" />
    <meta property="og:image" content="http://dndmagicmap.com/siteicon.png" />
    <meta property="og:description" content="Magic Map" />
    <meta property="og:url" content="http://dndmagicmap.com" />
    <meta property="og:site_name" content="Magic Map" />

    <!-- Fonts  -->
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:400,700,600' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="./css/font-face/entypo.css" type="text/css" />

    <!-- Styles  -->
    <link rel="stylesheet" href="./css/reset.css" type="text/css" />
    <link rel="stylesheet" href="./css/style.css" type="text/css" />

    <!-- Scripts -->
    <script src="./js/tweenmax.js"></script>
    <script src="./js/jquery.js"></script>
    <script src="./js/imagesloaded.js"></script>
    <script src="./js/crafty_max.js"></script>
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-114216700-1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'UA-114216700-1');
    </script>
    <script src="https://www.gstatic.com/firebasejs/4.12.0/firebase.js"></script>
    <script src="https://www.gstatic.com/firebasejs/4.12.0/firebase-firestore.js"></script>
    <script>
      var config = {
        apiKey: "AIzaSyAqKCnFuKutaPQhq7Aj1ZxRJLZAg922R80",
        authDomain: "dndmagicmap.firebaseapp.com",
        databaseURL: "https://dndmagicmap.firebaseio.com",
        projectId: "dndmagicmap",
        storageBucket: "dndmagicmap.appspot.com",
        messagingSenderId: "515412884380"
      };
      firebase.initializeApp(config);
    </script>
    <script type="text/javascript">

      var magicMap;
      var dashboardJSON;
      var mousedown = false;
      var alphabet="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz";
      var source_big, source_small, target_big, target_small;
      var sourceSet = false;
      var currentBackgroundTrack, backgroundAudio, imageAudio;
      var targetHidden = false;
      var craftyInit = false;
      var particleFx = new Array();
      var phantomTarget = null;
      var fx_shapes = {
        beam:{maxParticles:3000,size:15,sizeRandom:0,lifeSpan:15,lifeSpanRandom:0,emissionRate:50,speed:30,speedRandom:7,angle:-1,angleRandom:1},
        bomb:{maxParticles:500,size:15,sizeRandom:5,lifeSpan:15,lifeSpanRandom:7,speed:5,speedRandom:2,angle:270,angleRandom:75,emissionRate:75},
        bubbling:{maxParticles:200,size:15,sizeRandom:3,lifeSpan:20,lifeSpanRandom:5,speed:7,speedRandom:2,gravity:{x:.01,y:.65},angle:270,angleRandom:35,emissionRate:1},
        burn:{maxParticles:100,size:35,sizeRandom:15,lifeSpan:10,lifeSpanRandom:3,speed:3,angle:0,emissionRate:12},
        burst:{ maxParticles:100,size:35,sizeRandom:15,lifeSpan:10,lifeSpanRandom:3,speed:3,angle:0,emissionRate:12,'onDeath':'explosion-magic'},
        breath:{maxParticles:750,size:20,sizeRandom:10,lifeSpan:25,lifeSpanRandom:2,emissionRate:25,speed:15,speedRandom:3,angle:-1,angleRandom:30},
        cloud:{maxParticles:350,size:40,sizeRandom:5,lifeSpan:25,lifeSpanRandom:7,emissionRate:20,speed:3,speedRandom:1,gravity:{x:0.01,y:0.01},angle:360.0,angleRandom:360,sharpness:10,sharpnessRandom:3},
        explode:{maxParticles:300,size:35,sizeRandom:10,sharpnessRandom:10,sharpness:20,lifeSpan:20,lifeSpanRandom:5,speed:7,speedRandom:1,angle:0,angleRandom:360,emissionRate:1e4},
        glow:{maxParticles:500,size:5,sizeRandom:3,lifeSpan:17,lifeSpanRandom:5,emissionRate:7,speed:3,speedRandom:2,angle:270,angleRandom:45},
        missile:{maxParticles:350,size:7,sizeRandom:3,lifeSpan:7,lifeSpanRandom:5,emissionRate:50,speed:7,speedRandom:5,angle:135,angleRandom:0},
        nova:{maxParticles:500,size:15,sizeRandom:0,lifeSpan:30,lifeSpanRandom:0,emissionRate:1e3,speed:7,speedRandom:0,angle:0,angleRandom:180},
        orb:{maxParticles:50,size:60,sizeRandom:0,lifeSpan:30,lifeSpanRandom:0,emissionRate:2,speed:0,speedRandom:0,gravity:{x:0.0001,y:0.0001},angle:0.0,angleRandom:360,sharpness:55,sharpnessRandom:40},
        orbmissile:{maxParticles:300,size:60,sizeRandom:0,lifeSpan:30,lifeSpanRandom:0,emissionRate:40,speed:0,speedRandom:0,gravity:{x:0.0001,y:0.0001},angle:0.0,angleRandom:360,sharpness:55,sharpnessRandom:40},
        splatter:{maxParticles:750,size:7,sizeRandom:3,lifeSpan:20,lifeSpanRandom:5,emissionRate:3,speed:7,speedRandom:2,gravity:{x:.01,y:.5},angle:-1,angleRandom:20}
      };
      var fx_elements = {
        acid:{startColour:[0,218,0,1],startColourRandom:[0,60,20,0],endColour:[0,35,0,0],endColourRandom:[0,60,20,0]},
        blood:{startColour:[175,0,0,1],startColourRandom:[20,0,0,0],endColour:[175,0,0,0],endColourRandom:[20,0,0,0]},
        charm:{startColour:[200,40,150,1],startColourRandom:[25,5,20,.25],endColour:[200,40,150,0],endColourRandom:[50,10,40,0]},
        death:{startColour:[10,0,0,1],startColourRandom:[5,0,0,.25],endColour:[20,0,0,0],endColourRandom:[10,0,0,0]},
        dark:{startColour:[0,0,0,0],startColourRandom:[10,10,10,0],endColour:[0,0,0,1],endColourRandom:[10,10,10,0]},
        fire:{startColour:[220,35,0,1],startColourRandom:[62,0,0,.25],endColour:[220,35,0,0],endColourRandom:[60,60,60,0]},
        frost:{startColour:[90,90,175,1],startColourRandom:[0,0,0,.25],endColour:[125,125,255,0],endColourRandom:[0,0,0,0]},
        holy:{startColour:[255,255,240,1],startColourRandom:[10,10,10,1],endColour:[255,255,255,0],endColourRandom:[30,30,30,.25]},
        magic:{startColour:[50,50,50,.5],startColourRandom:[150,150,150,.25],endColour:[128,128,128,0],endColourRandom:[125,125,125,0]},
        magicmissile:{startColour:[60,60,60,60],startColourRandom:[30,30,30,30],endColour:[0,0,60,0],endColourRandom:[0,0,60,0]},
        slime:{startColour:[0,250,50,1],startColourRandom:[0,20,10,.25],endColour:[0,250,50,0],endColourRandom:[20,20,20,0]},
        smoke:{startColour:[150,150,150,1],startColourRandom:[10,10,10,.5],endColour:[200,200,200,0],endColourRandom:[10,10,10,0]},
        water:{startColour:[15,15,150,1],startColourRandom:[5,5,25,.25],endColour:[10,10,100,0],endColourRandom:[10,10,25,0]}
      };

      var firebaseUser = null;
      var db = firebase.firestore();
      var configurationsRef = db.collection("configurations");

      $(document).ready(function() {

        // Handle login
        firebase.auth().onAuthStateChanged(function(user) {
          if (!user) {
            window.location.replace('./');
          } else {
            // Load magic map
            firebaseUser = user;
            magicMap = window.open('', 'MagicMap');
            if (magicMap === null) {
              $("#loading").fadeOut(500);
              $("#notification").show(); // Popups blocked
              return;
            }
            if (magicMap.location.href === 'about:blank') {
              magicMap.close();
              magicMap = window.open('./magicmap','MagicMap','directories=no,titlebar=no,toolbar=no,location=no,status=no,menubar=no,scrollbars=no,resizable=yes,width=3840,height=2160,left=100,top=100');
              console.log('load');
              $(magicMap).on('load', function() {
                console.log('magicmapload');
                doOnMagicMapLoad();
              });   
            }
            else {
              console.log('blank');
              doOnMagicMapLoad();
            }
          }
        });
        
      });
      
      function doOnMagicMapLoad() {
        configurationsRef.doc(firebaseUser.uid).get().then(function(doc) {
            if (doc.exists) {
                loadDropdowns(doc.data().configuration);
            } else {
                // doc.data() will be undefined in this case
                console.log("No such document!");
                // TODO: Initialize with the default json 
                $.getJSON( "./json/dashboard.json", function(dashboardJSON ) {
                  configurationsRef.doc(firebaseUser.uid).set({
                    configuration: dashboardJSON
                  });
                  loadDropdowns(dashboardJSON);
                });
            }
        }).catch(function(error) {
            console.log("Error getting document:", error);
        });
        
        // Set source and targets
        source_big = $(magicMap.document).contents().find('.source_big');
        target_big = $(magicMap.document).contents().find('.target_big');
        source_small = $('.source_small');
        target_small = $('.target_small');
        
        // Record if mousebutton is being held down
        $(document).mouseup(function() { mousedown = false; }).mousedown(function() { mousedown = true; });
          
        // Check for magic map presence on each click
        $(document).mousedown(function() { 
          if (magicMap.closed) {
            $("#notification").show();
          }
        });
        
        // Hide preload screen
        $("#loading").fadeOut(500);
      }
      
      function loadDropdowns(dashboardJSON) {
        var mapoptions = [];
        var musicoptions = [];
        var videooptions = [];
        var imageoptions = [];
        $.each(dashboardJSON, function(i, obj) {
          if (obj.type == 'map') {
            mapoptions[i] = '<option value="' + obj.name + '" data-maptype="' + obj.maptype + '" data-name="' + obj.name + '" data-scale="' + obj.scale + '" data-mapx="' + obj.offset_x + '" data-mapy="' + obj.offset_y + '" data-maprotate="' + obj.rotate + '" data-urldm="' + encodeURI(obj.url_dm) + '" data-urlplayer="' + encodeURI(obj.url_player) + '">' + obj.name + '</option>';
          }
          else if (obj.type == 'music') {
            musicoptions[i] = '<option value="' + obj.name + '" data-name="' + obj.name + '" data-url="' + encodeURI(obj.url) + '">' + obj.name + '</option>';
          }
          else if (obj.type == 'video') {
            videooptions[i] = '<option value="' + obj.name + '" data-name="' + obj.name + '" data-url="' + encodeURI(obj.url) + '">' + obj.name + '</option>';
          }
          else if (obj.type == 'image') {
            var audio = "";
            if (typeof obj.url_audio !== 'undefined') audio = 'data-urlaudio="' + encodeURI(obj.url_audio) + '"';
            imageoptions[i] = '<option value="' + obj.name + '" data-name="' + obj.name + '" data-urlimage="' + encodeURI(obj.url_image) + '" ' + audio + ' data-duration="' + obj.duration + '">' + obj.name + '</option>';
          }
        });
        $('#select_choosemap').append(mapoptions.join(''));
        $('#select_soundtrack').append(musicoptions.join(''));
        $('#select_videosplash').append(videooptions.join(''));
        $('#select_imagesplash').append(imageoptions.join(''));
          
        var monstertokens = [];
        $.getJSON( "./json/monstertokens.json", function(data) {    
          $.each(data, function(i, obj) {
            monstertokens[i] = '<option value="' + obj.name + '" data-area="5ftsquare" data-audio="wav" data-image="png" data-sticky="true">' + obj.name + '</option>';
          });
          $('#select_monstereffect').append(monstertokens.join(''));
        });
        
        var monsters = [];
        $.getJSON( "./json/monsters.json", function(data) {    
          $.each(data, function(i, obj) {
            var challenge = obj.challenge;
            if (challenge == 0.125) challenge = '1/8';
            else if (challenge == 0.25) challenge = '1/4';
            else if (challenge == 0.5) challenge = '1/2';
            monsters[i] = '<option value="' + obj.art + '">' + obj.name + ' (' + challenge + ')</option>';
          });
          $('#select_monstersplash').append(monsters.join(''));
        });
        
        for(i = 3000; i > 0; i--) $('#select_mapscale').append('<option value="' + i/10 + '">' + i/10 + '</option');
        for(i = 0; i > -103; i--) $('#select_mapx').append('<option value="' + i + '">' + i + '</option');
        for(i = 0; i > -103; i--) $('#select_mapy').append('<option value="' + i + '">' + i + '</option');
        
        // Load map
        changeMap();
      }
      
      function changeMap(adjusting) {
        
        // Clear current effects
        $('.effect').remove();
        magicMap.removeAllEffects();
        for (i = particleFx.length - 1; i > -1; i--) {
          particleFx[i]['fx'].destroy();
          particleFx.splice(i, 1);
        }
        
        // Clear current source
        sourceSet=false;
        $(source_small).css({'display':'none'});
        $(source_big).css({'display':'none'});
        
        // Clear range
        $('.range_small').css({'display':'none'});
        var range_big = $(magicMap.document).contents().find('.range_big');
        $(range_big).css({'display':'none'});
        
        // Load phantoms to get size
        var newMap = $('select#select_choosemap option:checked');
        if (newMap.data('maptype') == 'image') 
        {
          // Load phantom image
          $('<img id="phantomImage" src="' + newMap.data('urlplayer') + '" />').appendTo('body').on('load', { maptype: "image" }, finishChangeMap);
        }
        else 
        {  
          // Get divs
          //var mapvideosource_small = $('#mapvideosource_small');
          //var mapvideo_small = $('#mapvideo_small');
          var mapvideosource_big = $(magicMap.document).contents().find('#mapvideosource_big');
          var mapvideo_big = $(magicMap.document).contents().find('#mapvideo_big');  
          
          // Load video
          //$(mapvideosource_small).attr('src', newMap.data('urldm'));
          //$(mapvideo_small)[0].load();
          $(mapvideosource_big).attr('src', newMap.data('urlplayer'));
          $(mapvideo_big)[0].load();
          
          // Pause music and play video
          $(mapvideo_big).on('canplaythrough', function(){ 
            //$(mapvideo_small).css('display', 'block');
            $(mapvideo_big).css('display', 'block');
            if (typeof backgroundAudio !== 'undefined') backgroundAudio.pause();
            //$(mapvideo_small)[0].volume = 0;
            $(mapvideo_big)[0].volume = 1;
            //$(mapvideo_small)[0].play();
            $(mapvideo_big)[0].play();
          });
        }
      }
      
      function finishChangeMap(event) {
        
        // Map sources
        var newMap = $('select#select_choosemap option:checked');
        var smallMap = newMap.data('urldm');
        var bigMap = newMap.data('urlplayer');
        if ($('select#select_mapversion option:checked').val() == 'dm') bigMap = smallMap;
        
        // Prepop adjusters
        $('select#select_mapscale').val(newMap.data('scale'));
        $('select#select_mapx').val(newMap.data('mapx'));
        $('select#select_mapy').val(newMap.data('mapy'));
        $('select#select_maprotate').val(newMap.data('maprotate'));
        
        if (event.data.maptype == 'image') 
        {
          // Set background images
          $('.map_small').css('background-image','url(' + smallMap + ')');
          $(magicMap.document).contents().find('.map_big').css('background-image','url(' + bigMap + ')');
        }
        else 
        {
          // Set video source
        }

        // Detect and set map dimensions 
        var newWidth = this.width;
        var newHeight = this.height;
        var origin_small, origin_big;
        if ($(newMap).attr('data-maprotate')) {
          if (newMap.data('maprotate') == '90') {
            newWidth = this.height;
            newHeight = this.width;
            origin_small = '21px 21px 0px';
            origin_big = '103px 103px 0px';
          }
          $('.map_small').css({'transform':'rotate(' + newMap.data('maprotate') + 'deg)','transform-origin':origin_small});
          $(magicMap.document).contents().find('.map_big').css({'transform':'rotate(' + newMap.data('maprotate') + 'deg)','transform-origin':origin_big});
        }
        if ($(newMap).attr('data-scale')) {
          newWidth = newWidth*parseFloat(newMap.data('scale'))/100;
          newHeight = newHeight*parseFloat(newMap.data('scale'))/100;
        }
        var offsetx = parseInt(newMap.data('mapx'));
        var offsety = parseInt(newMap.data('mapy'));
        var numSquaresWide = Math.floor(newWidth/103) + 2;
        var numSquaresHigh = Math.floor(newHeight/103) + 2;
        $('.map_small').css({'background-position': + (21 + offsetx/4.9047) + 'px ' + (21 + offsety/4.9047) + 'px', 'width': (numSquaresWide*21) + 'px', 'height': (numSquaresHigh*21) + 'px', 'background-size': newWidth/4.9047 + 'px ' + newHeight/4.9047 + 'px'});
        $(magicMap.document).contents().find('.map_big').css({'background-position': + (103 + offsetx) + 'px ' + (103 + offsety) + 'px', 'width': (numSquaresWide*103) + 'px', 'height': (numSquaresHigh*103) + 'px', 'background-size': newWidth + 'px ' + newHeight + 'px'});
        $('#phantomImage').remove();

        // Set up crafty canvas
        $('.splashparticlesscreen_small').css({'width':numSquaresWide*21, 'height':numSquaresHigh*103});
        $('#splashparticles_small').css({'width':numSquaresWide*21, 'height':numSquaresHigh*103});
        if (!craftyInit) {
          Crafty.init(numSquaresWide*21, numSquaresHigh*21, $('#splashparticles_small')[0]);
          craftyInit = true;
        }
        else {
          Crafty.viewport.width = numSquaresWide*21;
          Crafty.viewport.height = numSquaresHigh*21;
          Crafty.viewport.reload();
        }
        magicMap.initializeCanvas(numSquaresWide, numSquaresHigh);

        // Reset squares
        magicMap.initializeSquares(numSquaresWide, numSquaresHigh);
        $('.mapsquare_small').remove();
        for(j = 0; j < numSquaresHigh; j++) {
          for(i = 1; i <= numSquaresWide; i++) {
            $('.map_small').append('<div class="mapsquare_small" onmouseover="overSquare(this);" onmousedown="mapClick(this);" id="' + alphabet.charAt(j) + '_' + i + '"></div>');
          }
        }   

        if (typeof adjusting !== 'undefined' && adjusting == true) {
          // Handle grids
          $('.mapsquare_small').addClass('grid_smallgreen');
          $(magicMap.document).contents().find('.mapsquare_big').addClass('grid_biggreen');
        }
        else {
          // Handle grids
          $('.mapcontrols_bottom').show();
          $('.gridadjuster').hide();
          $('.mapsquare_small').removeClass('grid_smallgreen');
          $(magicMap.document).contents().find('.mapsquare_big').removeClass('grid_biggreen');
          toggleGrid(); 

          // Reset map position
          $('.map_small').css({'top':'-21px','left':'-21px'});
          $(magicMap.document).contents().find('.map_big').css({'top':'-103px','left':'-103px'});
        }

        // Clear fog if specified
        if ($('select#select_fogoption option:checked').val() == 'clear') {
          $('.mapsquare_small').css('background-color', 'rgba(0,0,0,0)');
          $(magicMap.document).contents().find('.mapsquare_big').css('background-color', 'rgba(0,0,0,0)');
        }

        // Switch back to fog of war action
        $('#fogofwar').prop('checked',true).change();
      }
      
      function openMapAdjuster() {
        $('.mapsquare_small').removeClass('grid_small');
        $(magicMap.document).contents().find('.mapsquare_big').removeClass('grid_big');
        $('.mapsquare_small').addClass('grid_smallgreen');
        $(magicMap.document).contents().find('.mapsquare_big').addClass('grid_biggreen');
        $('.mapcontrols_bottom').hide();
        $('.gridadjuster').show();
      }
      
      function adjustMap(done) {
        if (done) {      
          // Close editor
          $('.mapcontrols_bottom').show();
          $('.gridadjuster').hide();
          $('.mapsquare_small').removeClass('grid_smallgreen');
          $(magicMap.document).contents().find('.mapsquare_big').removeClass('grid_biggreen');
          toggleGrid();
        }
        else {          
          // Get new adjustments
          var mapscale = $('select#select_mapscale option:checked').val();
          var mapx = $('select#select_mapx option:checked').val();
          var mapy = $('select#select_mapy option:checked').val();
          var maprotate = $('select#select_maprotate option:checked').val();
          
          // Change data attributes in map dropdown with adjustments
          var currentMap = $('select#select_choosemap option:checked');
          currentMap.data('scale',mapscale);
          currentMap.data('mapx', mapx);
          currentMap.data('mapy', mapy)
          currentMap.data('maprotate', maprotate)
          
          // Change and save JSON data with adjustments
          $.each(dashboardJSON, function(i, obj) {
            if (obj.type == 'map' && obj.name == currentMap.val()) {
              obj.scale = mapscale;
              obj.offset_x = mapx;
              obj.offset_y = mapy;
              obj.rotate = maprotate;
            }
          });
          localStorage.setItem("dashboard", JSON.stringify(dashboardJSON));
          
          // Reload map
          changeMap(true);
        }
      }
      
      function moveMap(direction) {
        if (direction == 'up') {
          $('.map_small').css('top', '-=21');
          $(magicMap.document).contents().find('.map_big').css('top', '-=103');
        }
        else if (direction == 'down') {
          $('.map_small').css('top', '+=21');
          $(magicMap.document).contents().find('.map_big').css('top', '+=103');
        }
        else if (direction == 'left') {
          $('.map_small').css('left', '-=21');
          $(magicMap.document).contents().find('.map_big').css('left', '-=103');
        }
        else if (direction == 'right') {
          $('.map_small').css('left', '+=21');
          $(magicMap.document).contents().find('.map_big').css('left', '+=103');
        }
      }
      
      function toggleGrid() {
        if ($('#showgridbox').is(':checked')) {
          $('.mapsquare_small').addClass('grid_small');
          $(magicMap.document).contents().find('.mapsquare_big').addClass('grid_big');
        }
        else {
          $('.mapsquare_small').removeClass('grid_small');
          $(magicMap.document).contents().find('.mapsquare_big').removeClass('grid_big');
        }
      }

      function overSquare(square) {
        var actionradio = $('input[name="actionradio"]:checked').val();
        if (actionradio == 'fogofwar') {
          if (mousedown) {
            if ($('select#select_fogofwar option:checked').val() == 'clear') {
              $(square).css('background-color', 'rgba(0,0,0,0)');
              $(magicMap.document).contents().find('#' + square.id).css('background-color', 'rgba(0,0,0,0)');
            }
            else {
              $(square).css('background-color', 'rgba(0,0,0,0.4)');
              $(magicMap.document).contents().find('#' + square.id).css('background-color', 'rgba(0,0,0,1)');
            }
          }
          return;
        }
        else if (actionradio == 'setsource') {
          $(source_small).css({'display':'block','left':$(square).position().left, 'top':$(square).position().top});
          $(source_big).css({'display':'block','left':$(square).position().left/21*103, 'top':$(square).position().top/21*103});
          return;
        }
        else if (actionradio == 'spelleffect' || actionradio == 'attackeffect' || actionradio == 'monstereffect' || actionradio == 'othereffect') {
          if (targetHidden) return;
          else {
            if (actionradio != 'spelleffect') {
              $(target_small).css({'display':'block','left':$(square).position().left, 'top':$(square).position().top});
              $(target_big).css({'display':'block','left':$(square).position().left/21*103, 'top':$(square).position().top/21*103});
              return;
            }
            else {
              var spell = $('select#select_spelleffect option:checked');
              if ($(spell).attr('data-fromself')) {
                if (!sourceSet) return;
                xs = $('.source_small').position().left/21;
                ys = $('.source_small').position().top/21;
                x = $(square).position().left/21;
                y = $(square).position().top/21;
                var angle = Math.atan2(y - ys, x - xs) * 180 / Math.PI + 90;
                var distance = Math.sqrt((x-xs)*(x-xs) + (y-ys)*(y-ys));
                if (spell.data('area')=='15ftsquare') {
                  if (distance == 0) {
                    $(target_small).css({'display':'block','left':(xs-1)*21, 'top':(ys-1)*21});
                    $(target_big).css({'display':'block','left':(xs-1)*103, 'top':(ys-1)*103});
                  }
                  else if (distance >= 1 && distance < 2) {
                    if (angle > -22.5 && angle <= 22.5) {
                      // North
                      $(target_small).css({'display':'block','left':(xs-1)*21, 'top':(ys-2)*21});
                      $(target_big).css({'display':'block','left':(xs-1)*103, 'top':(ys-2)*103});
                    }
                    else if (angle > 22.5 && angle <= 67.5) {
                      // Northeast
                      $(target_small).css({'display':'block','left':(xs)*21, 'top':(ys-2)*21});
                      $(target_big).css({'display':'block','left':(xs)*103, 'top':(ys-2)*103});
                    }
                    else if (angle > 67.5 && angle <= 112.5) {
                      // East
                      $(target_small).css({'display':'block','left':(xs)*21, 'top':(ys-1)*21});
                      $(target_big).css({'display':'block','left':(xs)*103, 'top':(ys-1)*103});
                    }
                    else if (angle > 112.5 && angle <= 157.5) {
                      // Southeast
                      $(target_small).css({'display':'block','left':(xs)*21, 'top':(ys)*21});
                      $(target_big).css({'display':'block','left':(xs)*103, 'top':(ys)*103});
                    }
                    else if (angle > 157.5 && angle <= 202.5) {
                      // South
                      $(target_small).css({'display':'block','left':(xs-1)*21, 'top':(ys)*21});
                      $(target_big).css({'display':'block','left':(xs-1)*103, 'top':(ys)*103});
                    }
                    else if (angle > 202.5 && angle <= 247.5) {
                      // Southwest
                      $(target_small).css({'display':'block','left':(xs-2)*21, 'top':(ys)*21});
                      $(target_big).css({'display':'block','left':(xs-2)*103, 'top':(ys)*103});
                    }
                    else if ((angle > 247.5 && angle <= 270) || (angle > -90 && angle <= -67.5)) {
                      // West
                      $(target_small).css({'display':'block','left':(xs-2)*21, 'top':(ys-1)*21});
                      $(target_big).css({'display':'block','left':(xs-2)*103, 'top':(ys-1)*103});
                    }
                    else if (angle > -67.5 && angle <= -22.5) {
                      // Northwest
                      $(target_small).css({'display':'block','left':(xs-2)*21, 'top':(ys-2)*21});
                      $(target_big).css({'display':'block','left':(xs-2)*103, 'top':(ys-2)*103});
                    }
                    return;
                  }
                  else if (distance >= 2) {
                    if (angle > -22.5 && angle <= 22.5) {
                      // North
                      $(target_small).css({'display':'block','left':(xs-1)*21, 'top':(ys-3)*21});
                      $(target_big).css({'display':'block','left':(xs-1)*103, 'top':(ys-3)*103});
                    }
                    else if (angle > 22.5 && angle <= 67.5) {
                      // Northeast
                      $(target_small).css({'display':'block','left':(xs+1)*21, 'top':(ys-3)*21});
                      $(target_big).css({'display':'block','left':(xs+1)*103, 'top':(ys-3)*103});
                    }
                    else if (angle > 67.5 && angle <= 112.5) {
                      // East
                      $(target_small).css({'display':'block','left':(xs+1)*21, 'top':(ys-1)*21});
                      $(target_big).css({'display':'block','left':(xs+1)*103, 'top':(ys-1)*103});
                    }
                    else if (angle > 112.5 && angle <= 157.5) {
                      // Southeast
                      $(target_small).css({'display':'block','left':(xs+1)*21, 'top':(ys+1)*21});
                      $(target_big).css({'display':'block','left':(xs+1)*103, 'top':(ys+1)*103});
                    }
                    else if (angle > 157.5 && angle <= 202.5) {
                      // South
                      $(target_small).css({'display':'block','left':(xs-1)*21, 'top':(ys+1)*21});
                      $(target_big).css({'display':'block','left':(xs-1)*103, 'top':(ys+1)*103});
                    }
                    else if (angle > 202.5 && angle <= 247.5) {
                      // Southwest
                      $(target_small).css({'display':'block','left':(xs-3)*21, 'top':(ys+1)*21});
                      $(target_big).css({'display':'block','left':(xs-3)*103, 'top':(ys+1)*103});
                    }
                    else if ((angle > 247.5 && angle <= 270) || (angle > -90 && angle <= -67.5)) {
                      // West
                      $(target_small).css({'display':'block','left':(xs-3)*21, 'top':(ys-1)*21});
                      $(target_big).css({'display':'block','left':(xs-3)*103, 'top':(ys-1)*103});
                    }
                    else if (angle > -67.5 && angle <= -22.5) {
                      // Northwest
                      $(target_small).css({'display':'block','left':(xs-3)*21, 'top':(ys-3)*21});
                      $(target_big).css({'display':'block','left':(xs-3)*103, 'top':(ys-3)*103});
                    }
                    return;
                  }
                }
                else if (spell.data('area')=='15ftcone') {
                  if (distance > 0) {
                    if (angle > -22.5 && angle <= 22.5) {
                      // North
                      $(target_small).css({'display':'block','left':(xs-1)*21, 'top':(ys-3)*21, 'transform':'rotate(0deg)', 'background-image':'url(./img/target_15ftcone_straight.png)'});
                      $(target_big).css({'display':'block','left':(xs-1)*103, 'top':(ys-3)*103, 'transform':'rotate(0deg)', 'background-image':'url(./img/target_15ftcone_straight.png)'});
                      phantomTarget = {'x': xs, 'y': ys-1 };
                    }
                    else if (angle > 22.5 && angle <= 67.5) {
                      // Northeast
                      $(target_small).css({'display':'block','left':(xs+1)*21, 'top':(ys-3)*21, 'transform':'rotate(0deg)', 'background-image':'url(./img/target_15ftcone_diag.png)'});
                      $(target_big).css({'display':'block','left':(xs+1)*103, 'top':(ys-3)*103, 'transform':'rotate(0deg)', 'background-image':'url(./img/target_15ftcone_diag.png)'});
                      phantomTarget = {'x': xs+1, 'y': ys-1 };
                    }
                    else if (angle > 67.5 && angle <= 112.5) {
                      // East
                      $(target_small).css({'display':'block','left':(xs+1)*21, 'top':(ys-1)*21, 'transform':'rotate(90deg)', 'background-image':'url(./img/target_15ftcone_straight.png)'});
                      $(target_big).css({'display':'block','left':(xs+1)*103, 'top':(ys-1)*103, 'transform':'rotate(90deg)', 'background-image':'url(./img/target_15ftcone_straight.png)'});
                      phantomTarget = {'x': xs+1, 'y': ys };
                    }
                    else if (angle > 112.5 && angle <= 157.5) {
                      // Southeast
                      $(target_small).css({'display':'block','left':(xs+1)*21, 'top':(ys+1)*21, 'transform':'rotate(90deg)', 'background-image':'url(./img/target_15ftcone_diag.png)'});
                      $(target_big).css({'display':'block','left':(xs+1)*103, 'top':(ys+1)*103, 'transform':'rotate(90deg)', 'background-image':'url(./img/target_15ftcone_diag.png)'});
                      phantomTarget = {'x': xs+1, 'y': ys+1 };
                    }
                    else if (angle > 157.5 && angle <= 202.5) {
                      // South
                      $(target_small).css({'display':'block','left':(xs-1)*21, 'top':(ys+1)*21, 'transform':'rotate(180deg)', 'background-image':'url(./img/target_15ftcone_straight.png)'});
                      $(target_big).css({'display':'block','left':(xs-1)*103, 'top':(ys+1)*103, 'transform':'rotate(180deg)', 'background-image':'url(./img/target_15ftcone_straight.png)'});
                      phantomTarget = {'x': xs, 'y': ys+1 };
                    }
                    else if (angle > 202.5 && angle <= 247.5) {
                      // Southwest
                      $(target_small).css({'display':'block','left':(xs-3)*21, 'top':(ys+1)*21, 'transform':'rotate(180deg)', 'background-image':'url(./img/target_15ftcone_diag.png)'});
                      $(target_big).css({'display':'block','left':(xs-3)*103, 'top':(ys+1)*103, 'transform':'rotate(180deg)', 'background-image':'url(./img/target_15ftcone_diag.png)'});
                      phantomTarget = {'x': xs-1, 'y': ys+1 };
                    }
                    else if ((angle > 247.5 && angle <= 270) || (angle > -90 && angle <= -67.5)) {
                      // West
                      $(target_small).css({'display':'block','left':(xs-3)*21, 'top':(ys-1)*21, 'transform':'rotate(270deg)', 'background-image':'url(./img/target_15ftcone_straight.png)'});
                      $(target_big).css({'display':'block','left':(xs-3)*103, 'top':(ys-1)*103, 'transform':'rotate(270deg)', 'background-image':'url(./img/target_15ftcone_straight.png)'});
                      phantomTarget = {'x': xs-1, 'y': ys };
                    }
                    else if (angle > -67.5 && angle <= -22.5) {
                      // Northwest
                      $(target_small).css({'display':'block','left':(xs-3)*21, 'top':(ys-3)*21, 'transform':'rotate(270deg)', 'background-image':'url(./img/target_15ftcone_diag.png)'});
                      $(target_big).css({'display':'block','left':(xs-3)*103, 'top':(ys-3)*103, 'transform':'rotate(270deg)', 'background-image':'url(./img/target_15ftcone_diag.png)'});
                      phantomTarget = {'x': xs-1, 'y': ys-1 };
                    }
                    return;
                  }
                }
                else {
                  $(target_small).css({'display':'block','left':$(square).position().left, 'top':$(square).position().top});
                  $(target_big).css({'display':'block','left':$(square).position().left/21*103, 'top':$(square).position().top/21*103});
                  return;
                }
              }
              else {
                $(target_small).css({'display':'block','left':$(square).position().left, 'top':$(square).position().top});
                $(target_big).css({'display':'block','left':$(square).position().left/21*103, 'top':$(square).position().top/21*103});
                return;
              }
            }
          }
        }
      }
      
      function mapOut() {
        // Clear target & source
        $(target_small).css({'display':'none'});
        $(target_big).css({'display':'none'});
        if (!sourceSet) {
          $(source_small).css({'display':'none'});
          $(source_big).css({'display':'none'});
        }
      }
      
      function actionradioChanged() {
        // Clear target
        $(target_small).css({'display':'none'});
        $(target_big).css({'display':'none'});
          
        // Clear range
        $('.range_small').css({'display':'none'});
        var range_big = $(magicMap.document).contents().find('.range_big');
        $(range_big).css({'display':'none'});
      
        // Clear source
        var actionradio = $('input[name="actionradio"]:checked').val();
        if (actionradio == 'setsource') {
          sourceSet=false;
          $(source_small).css({'display':'none'});
          $(source_big).css({'display':'none'});
        }
        else if (actionradio == 'spelleffect' || actionradio == 'attackeffect' || actionradio == 'monstereffect' || actionradio == 'othereffect') {
          effectChanged();
        }
      }
      
      function effectChanged() {
        var actionradio = $('input[name="actionradio"]:checked').val();
        var effect;
        var effectType;
        if (actionradio == 'spelleffect') {
          effect = $('select#select_spelleffect option:checked');
          effectType = 'spell';
        }
        else if (actionradio == 'attackeffect') { 
          effect = $('select#select_attackeffect option:checked');
          effectType = 'attack';
        }
        else if (actionradio == 'monstereffect') {
          effect = $('select#select_monstereffect option:checked');
          effectType = 'monster';
        }
        else if (actionradio == 'othereffect') {
          effect = $('select#select_othereffect option:checked');
          effectType = 'other';
        }
          
        // Preload image if there is one
        if ($(effect).attr('data-image')) {
          if (effect.val() != '') {
            var effectImage = new Image();
            var imageSrc = './img/' + effectType + '_' + effect.val() + '.' + effect.data('image');
            if (effectType == 'monster') {
              imageSrc = './img/monsters/' + encodeURI(effect.val()) + '.' + effect.data('image');
            }
            effectImage.src = imageSrc;
          }
        }
        
        // Handle range
        if ($(effect).attr('data-range')) {
          if (sourceSet) {
            var rangeSquares = effect.data('range')/5 * 2;
            $('.range_small').css({'display':'block','width':rangeSquares*21,'height':rangeSquares*21,'left':$(source_small).position().left - rangeSquares*21/2 + 10.5, 'top':$(source_small).position().top - rangeSquares*21/2 + 10.5});
            var range_big = $(magicMap.document).contents().find('.range_big');
            $(range_big).css({'display':'block','width':rangeSquares*103,'height':rangeSquares*103,'left':$(source_big).position().left - rangeSquares*103/2 + 51.5, 'top':$(source_big).position().top - rangeSquares*103/2 + 51.5});
          }
        }
        else {
          $('.range_small').css({'display':'none'});
          var range_big = $(magicMap.document).contents().find('.range_big');
          $(range_big).css({'display':'none'});
        }
        
        // Handle target size (5ft square is default)
        if ($(effect).attr('data-area')) {
          if (effect.data('area')=='5ftsquare') {
            $(target_small).css({'width':'21px','height':'21px', 'background-image':'url(./img/target_5ftsquare.png)'});
            $(target_big).css({'width':'103px','height':'103px', 'background-image':'url(./img/target_5ftsquare.png)'});
          }
          else if (effect.data('area')=='10ftsquare') {
            $(target_small).css({'width':'42px','height':'42px', 'background-image':'url(./img/target_10ftsquare.png)'});
            $(target_big).css({'width':'206px','height':'206x', 'background-image':'url(./img/target_10ftsquare.png)'});
          }
          else if (effect.data('area')=='15ftsquare') {
            $(target_small).css({'width':'63px','height':'63px', 'background-image':'url(./img/target_15ftsquare.png)'});
            $(target_big).css({'width':'309px','height':'309px', 'background-image':'url(./img/target_15ftsquare.png)'});
          }
          else if (effect.data('area')=='15ftcone') {
            $(target_small).css({'width':'63px','height':'63px', 'background-image':'url(./img/target_15ftcone_diag.png)'});
            $(target_big).css({'width':'309px','height':'309px', 'background-image':'url(./img/target_15ftcone_straight.png)'});
          }
          else if (effect.data('area')=='20ftsquare') {
            $(target_small).css({'width':'84px','height':'84px', 'background-image':'url(./img/target_20ftsquare.png)'});
            $(target_big).css({'width':'412px','height':'412px', 'background-image':'url(./img/target_20ftsquare.png)'});
          }
          else if (effect.data('area')=='20ftcircle') {
            $(target_small).css({'width':'84px','height':'84px', 'background-image':'url(./img/target_20ftcircle.png)'});
            $(target_big).css({'width':'412px','height':'412px', 'background-image':'url(./img/target_20ftcircle.png)'});
          }
          else if (effect.data('area')=='20ftcone') {
            $(target_small).css({'width':'84px','height':'84px', 'background-image':'url(./img/target_5ftsquare.png)'});
            $(target_big).css({'width':'412px','height':'412px', 'background-image':'url(./img/target_5ftsquare.png)'});
          }
          else if (effect.data('area')=='20ftline') {
            $(target_small).css({'width':'84px','height':'84px', 'background-image':'url(./img/target_20ftline.png)'});
            $(target_big).css({'width':'412px','height':'412px', 'background-image':'url(./img/target_20ftline.png)'});
          }
        }
        else {
          $(target_small).css({'width':'21px','height':'21px', 'background-image':'url(./img/target_5ftsquare.png)'});
          $(target_big).css({'width':'103px','height':'103px', 'background-image':'url(./img/target_5ftsquare.png)'});
        }
      }

      function mapClick(square) {
        var actionradio = $('input[name="actionradio"]:checked').val();
        if (actionradio == 'fogofwar') {
          if ($('select#select_fogofwar option:checked').val() == 'clear') {
            $(square).css('background-color', 'rgba(0,0,0,0)');
            $(magicMap.document).contents().find('#' + square.id).css('background-color', 'rgba(0,0,0,0)');
          }
          else {
            $(square).css('background-color', 'rgba(0,0,0,0.4)');
            $(magicMap.document).contents().find('#' + square.id).css('background-color', 'rgba(0,0,0,1)');
          }
        }
        else if (actionradio == 'setsource') {
          sourceSet = true;
          targetHidden = false; // In case it gets stuck
          $('#spelleffect').prop('checked',true).change();
        }
        else if (actionradio == 'cleareffect') {
          clearEffectsAt(square.id);
          if ($(square).position().left == $(source_small).position().left && $(square).position().top == $(source_small).position().top) {
            $(source_small).css({'display':'none'});
            $(source_big).css({'display':'none'});
          }
        }
        else 
        {  
          // Handle all other effects (spells, attacks, monsters, other)
          var effect;
          var effectType;
          if (actionradio == 'spelleffect') {
            effect = $('select#select_spelleffect option:checked');
            effectType = 'spell';
            if ($(effect).attr('data-fromself') && !sourceSet) return; // Stop if no source for fromself spells
          }
          else if (actionradio == 'attackeffect') { 
            effect = $('select#select_attackeffect option:checked');
            effectType = 'attack';
          }
          else if (actionradio == 'monstereffect') {
            effect = $('select#select_monstereffect option:checked');
            effectType = 'monster';
          }
          else if (actionradio == 'othereffect') {
            effect = $('select#select_othereffect option:checked');
            effectType = 'other';
          }
          
          if (effect.val() == '') return;
          else
          {
            // Get coordinates
            x = $('.target_small').position().left/21;
            y = $('.target_small').position().top/21;
            if (phantomTarget != null) {
              x = phantomTarget.x;
              y = phantomTarget.y;
              phantomTarget = null;
            }
            
            // Load image if there is one
            if ($(effect).attr('data-image'))
            {
              // Place large effect
              var effectId = 'e_' + Math.floor((new Date).getTime() + Math.random());
              magicMap.createEffect(effectId, 'effect big_' + effect.data('area'), x, y);
              var bigdiv = $(magicMap.document).contents().find('#' + effectId);
            
              // Place small effect
              var smalldiv = $('<div id="' + effectId + '" class="effect small_' + effect.data('area') + '" data-xy="' + square.id + '"></div>');
              smalldiv.appendTo('.map_small');
            
              // Start animation when both image and audio are loaded
              var imageSrc = './img/' + effectType + '_' + effect.val() + '.' + effect.data('image');
              if (effectType == 'monster') {
                imageSrc = './img/monsters/' + encodeURI(effect.val()) + '.' + effect.data('image');
              }
              $(bigdiv).css('background-image','url(' + imageSrc + ')');
              $(smalldiv).css({'left':x*21,'top':y*21,'background-image':'url(' + imageSrc + ')'});
              $(smalldiv).imagesLoaded({background:true}, function() {
                if ($(effect).attr('data-audio')) {
                  var audio;
                  if (effectType == 'monster') {
                    audio = new Audio('/media/effect_monster.wav');
                    audio.volume = 0.1;     
                  }
                  else {
                    audio = new Audio('/media/' + effectType + '_' + effect.val() + '.' + effect.data('audio'));
                  }
                  audio.addEventListener('canplaythrough', function(){ runAnimation(effect, effectType, x, y, audio, square.id, smalldiv, bigdiv, effectId); }, false);
                }
                else {
                  runAnimation(effect, effectType, x, y, audio, square.id, smalldiv, bigdiv, effectId);
                }
              });
            }
            else 
            {
              // Run animation with particle effect
              if ($(effect).attr('data-audio')) {
                var audio = new Audio('/media/' + effectType + '_' + effect.val() + '.' + effect.data('audio'));
                audio.addEventListener('canplaythrough', function(){ runAnimation(effect, effectType, x, y, audio, square.id); }, false);
              }
              else {
                runAnimation(effect, effectType, x, y, audio, square.id);
              }
            }
          }
        }
      }
      
      function runAnimation(effect, effectType, x, y, audio, squareId, smalldiv, bigdiv, effectId) {  
      
        // Play audio
        if  (typeof audio !== 'undefined') {
          if (effectType != 'monster' && effectType != 'other') audio.play();
          else setTimeout(function() { audio.play(); }, 900);
        }
        
        // Check sticky
        var isSticky = false;
        if ($(effect).attr('data-sticky') && effect.data('sticky')) isSticky = true;
        
        // Temporarily hide target so we can see the animation
        $(target_small).css({'display':'none'});
        $(target_big).css({'display':'none'});
        targetHidden = true;
        
        // Restart animated gifs
        if (typeof smalldiv !== 'undefined') {
          var background = $(smalldiv).css('background-image');
          $(smalldiv).css({'background-image':'none'});
          $(bigdiv).css({'background-image':'none'});
          $(smalldiv).css({'background-image':background});
          $(bigdiv).css({'background-image':background});
        }
        
        // Run animation
        if (effectType == 'monster' || effectType == 'other') {
          smalldiv.css({'display':'block','transform':'scale(3)'});
          TweenLite.to(smalldiv, 0.9, {css:{scale:1}, ease:Power2.easeIn, onComplete:finishAnimation, onCompleteParams:[isSticky,effectId]});
          bigdiv.css({'display':'block','transform':'scale(3)'});
          TweenLite.to(bigdiv, 0.9, {css:{scale:1}, ease:Power2.easeIn});
        }
        else {
          if (effect.data('animation') == 'bonfire') {
            smalldiv.css({'display':'block','transform':'scale(3)'});
            if (sourceSet) smalldiv.css({'left':$('.source_small').position().left, 'top':$('.source_small').position().top});
            TweenLite.to(smalldiv, 0.9, {css:{left:x*21, top:y*21, scale:1.2}, ease:Power2.easeIn, onComplete:finishAnimation, onCompleteParams:[isSticky,effectId]});
            bigdiv.css({'display':'block','transform':'scale(3)'});
            if (sourceSet) bigdiv.css({'left':$(magicMap.document).contents().find('.source_big').position().left, 'top':$(magicMap.document).contents().find('.source_big').position().top});
            TweenLite.to(bigdiv, 0.9, {css:{left:x*103, top:y*103, scale:1.2}, ease:Power2.easeIn});
          }
          else if (effect.data('animation') == 'breathweapon') {
            runParticleAnimation('breath', 'fire', 1, x, y, isSticky, squareId, effect);
          }
          else if (effect.data('animation') == 'burninghands') {
            runParticleAnimation('breath', 'fire', 1, x, y, isSticky, squareId, effect);
          }
          else if (effect.data('animation') == 'chromaticorb') {
            runParticleAnimation('explode', 'magic', 0.5, x, y, isSticky, squareId, effect);
          }
          else if (effect.data('animation') == 'cloudofdaggers') {
            smalldiv.css({'display':'block','transform':'scale(4)'});
            var tl = new TimelineMax();
            tl.to(smalldiv, 1, {css:{scale:1, rotation:'+=360', transformOrigin:'50% 50%'}});
            tl.play();
            tl = new TimelineMax({repeat:-1,repeatDelay:5});
            tl.to(smalldiv, 2, {rotation:'+=360', transformOrigin:'50% 50%'});
            tl.play();
            bigdiv.css({'display':'block','transform':'scale(3)'});
            tl = new TimelineMax();
            tl.to(bigdiv, 1, {css:{scale:1, rotation:'+=360'}, onComplete:finishAnimation, onCompleteParams:[isSticky,effectId]});
            tl.play();
            tl = new TimelineMax({repeat:-1,repeatDelay:5});
            tl.to(bigdiv, 2, {rotation:'+=360', transformOrigin:'50% 50%'});
            tl.play();
          }
          else if (effect.data('animation') == 'darkness') {
            runParticleAnimation('orb', 'dark', 1, x, y, isSticky, squareId, effect);
          }
          else if (effect.data('animation') == 'fireball') {
            smalldiv.css({'display':'block','transform':'scale(4)'});
            TweenLite.to(smalldiv, 3, {scale:2, onComplete:finishAnimation, onCompleteParams:[isSticky,effectId]});
            bigdiv.css({'display':'block','transform':'scale(4)'});
            TweenLite.to(bigdiv, 3, {scale:2});
          }
          else if (effect.data('animation') == 'firebolt') {
            runParticleAnimation('orbmissile', 'fire', 0.4, x, y, isSticky, squareId, effect);
          }
          else if (effect.data('animation') == 'guidingbolt') {
            smalldiv.css({'display':'block','transform':'scale(2)'});
            if (sourceSet) smalldiv.css({'left':$('.source_small').position().left, 'top':$('.source_small').position().top});
            TweenLite.to(smalldiv, 0.6, {css:{left:x*21, top:y*21, scale:5}, ease:Power2.easeOut, onComplete:finishAnimation, onCompleteParams:[isSticky,effectId]});
            bigdiv.css({'display':'block','transform':'scale(2)'});
            if (sourceSet) bigdiv.css({'left':$(magicMap.document).contents().find('.source_big').position().left, 'top':$(magicMap.document).contents().find('.source_big').position().top});
            TweenLite.to(bigdiv, 0.6, {css:{left:x*103, top:y*103, scale:5}, ease:Power2.easeOut});
          }
          else if (effect.data('animation') == 'heal') {
            smalldiv.css({'display':'block','transform':'scale(6)'});
            TweenLite.to(smalldiv, 3, {css:{left:x*21, top:y*21, scale:4}, ease:Power2.easeIn, onComplete:finishAnimation, onCompleteParams:[isSticky,effectId]});
            bigdiv.css({'display':'block','transform':'scale(6)'});
            TweenLite.to(bigdiv, 3, {css:{left:x*103, top:y*103, scale:4}, ease:Power2.easeIn});
          }
          else if (effect.data('animation') == 'magicmissile') {
            runParticleAnimation('orbmissile', 'holy', 0.4, x, y, isSticky, squareId, effect);
          }  
          else if (effect.data('animation') == 'moonbeam') {
            runParticleAnimation('orb', 'holy', 0.66, x, y, isSticky, squareId, effect);
          }
          else if (effect.data('animation') == 'poisoncloud') {
            runParticleAnimation('cloud', 'acid', 0.5, x, y, isSticky, squareId, effect);
          }
          else if (effect.data('animation') == 'sacredflame') {
            smalldiv.css({'display':'block','transform':'scale(2)'});
            TweenLite.to(smalldiv, 3, {scale:4, onComplete:finishAnimation, onCompleteParams:[isSticky,effectId]});
            bigdiv.css({'display':'block','transform':'scale(2)'});
            TweenLite.to(bigdiv, 3, {scale:4});
          }
          else if (effect.data('animation') == 'scorchingray') {
            runParticleAnimation('beam', 'fire', 1, x, y, isSticky, squareId, effect);
          }
          else if (effect.data('animation') == 'shatter') {
            smalldiv.css({'display':'block','transform':'scale(3)'});
            TweenLite.to(smalldiv, 2, {scale:1.5, onComplete:finishAnimation, onCompleteParams:[isSticky,effectId]});
            bigdiv.css({'display':'block','transform':'scale(3)'});
            TweenLite.to(bigdiv, 2, {scale:1.5});
          }
          else if (effect.data('animation') == 'spiritualweapon') {
            smalldiv.css({'display':'block','transform':'scale(3)'});
            var tl = new TimelineMax();
            tl.to(smalldiv, 1, {css:{scale:1, rotation: -30}, ease:Power2.easeIn});
            tl.play();
            tl = new TimelineMax({repeat:-1, delay:10, repeatDelay:10});
            tl.to(smalldiv, 2, {rotation:0 });
            tl.to(smalldiv, 0.5, {rotation:-30, ease:Power2.easeIn});
            tl.play();
            bigdiv.css({'display':'block','transform':'scale(2)'});
            tl = new TimelineMax();
            tl.to(bigdiv, 1, {css:{scale:1, rotation: -30}, ease:Power2.easeIn, onComplete:finishAnimation, onCompleteParams:[isSticky,effectId]});
            tl.play();
            tl = new TimelineMax({repeat:-1, delay:10, repeatDelay:10});
            tl.to(bigdiv, 2, {rotation:0 });
            tl.to(bigdiv, 0.5, {rotation:-30, ease:Power2.easeIn});
            tl.play();
          }
          else if (effect.data('animation') == 'thunderwave') {
            smalldiv.css({'display':'block','transform':'scale(3)'});
            TweenLite.to(smalldiv, 2, {scale:1.5, onComplete:finishAnimation, onCompleteParams:[isSticky,effectId]});
            bigdiv.css({'display':'block','transform':'scale(3)'});
            TweenLite.to(bigdiv, 2, {scale:1.5});
          }
          else if (effect.data('animation') == 'direwolf') {
            smalldiv.css({'display':'block','transform':'scale(6)'});
            TweenLite.to(smalldiv, 1, {css:{left:x*21, top:y*21, scale:4}, ease:Power2.easeIn, onComplete:finishAnimation, onCompleteParams:[isSticky,effectId]});
            bigdiv.css({'display':'block','transform':'scale(6)'});
            TweenLite.to(bigdiv, 1, {css:{left:x*103+40, top:y*103-40, scale:4}, ease:Power2.easeIn});
          }
          else if (effect.data('animation') == 'dualrapier') {
            smalldiv.css({'display':'block','transform':'scale(6)'});
            TweenLite.to(smalldiv, 1.5, {css:{left:x*21, top:y*21, scale:4}, ease:Power2.easeIn, onComplete:finishAnimation, onCompleteParams:[isSticky,effectId]});
            bigdiv.css({'display':'block','transform':'scale(6)'});
            TweenLite.to(bigdiv, 1.5, {css:{left:x*103, top:y*103, scale:4}, ease:Power2.easeIn});
          }
          else if (effect.data('animation') == 'flourish') {
            smalldiv.css({'display':'block','transform':'scale(6)'});
            TweenLite.to(smalldiv, 1.5, {css:{left:x*21, top:y*21, scale:4}, ease:Power2.easeIn, onComplete:finishAnimation, onCompleteParams:[isSticky,effectId]});
            bigdiv.css({'display':'block','transform':'scale(6)'});
            TweenLite.to(bigdiv, 1.5, {css:{left:x*103, top:y*103, scale:4}, ease:Power2.easeIn});
          }
          else if (effect.data('animation') == 'longbow') {
            smalldiv.css({'display':'block','transform':'scale(2)'});
            if (sourceSet) smalldiv.css({'left':$('.source_small').position().left, 'top':$('.source_small').position().top});
            TweenLite.to(smalldiv, 0.6, {css:{left:x*21, top:y*21, scale:5}, ease:Power2.easeOut, onComplete:finishAnimation, onCompleteParams:[isSticky,effectId]});
            bigdiv.css({'display':'block','transform':'scale(2)'});
            if (sourceSet) bigdiv.css({'left':$(magicMap.document).contents().find('.source_big').position().left, 'top':$(magicMap.document).contents().find('.source_big').position().top});
            TweenLite.to(bigdiv, 0.6, {css:{left:x*103, top:y*103, scale:5}, ease:Power2.easeOut});
          }
          else if (effect.data('animation') == 'longsword') {
            smalldiv.css({'display':'block','transform':'scale(6)'});
            TweenLite.to(smalldiv, 1, {css:{left:x*21, top:y*21, scale:4}, ease:Power2.easeIn, onComplete:finishAnimation, onCompleteParams:[isSticky,effectId]});
            bigdiv.css({'display':'block','transform':'scale(6)'});
            TweenLite.to(bigdiv, 1, {css:{left:x*103, top:y*103, scale:4}, ease:Power2.easeIn});
          }
          else if (effect.data('animation') == 'mace') {
            smalldiv.css({'display':'block','transform':'scale(6)'});
            TweenLite.to(smalldiv, 1, {css:{left:x*21, top:y*21, scale:4}, ease:Power2.easeIn, onComplete:finishAnimation, onCompleteParams:[isSticky,effectId]});
            bigdiv.css({'display':'block','transform':'scale(6)'});
            TweenLite.to(bigdiv, 1, {css:{left:x*103, top:y*103, scale:4}, ease:Power2.easeIn});
          }
          else if (effect.data('animation') == 'viciousmockery') {
            smalldiv.css({'display':'block','transform':'scale(2)'});
            if (sourceSet) smalldiv.css({'left':$('.source_small').position().left, 'top':$('.source_small').position().top});
            TweenLite.to(smalldiv, 0.6, {css:{left:x*21, top:y*21, scale:5}, ease:Power2.easeOut, onComplete:finishAnimation, onCompleteParams:[isSticky,effectId]});
            bigdiv.css({'display':'block','transform':'scale(2)'});
            if (sourceSet) bigdiv.css({'left':$(magicMap.document).contents().find('.source_big').position().left, 'top':$(magicMap.document).contents().find('.source_big').position().top});
            TweenLite.to(bigdiv, 0.6, {css:{left:x*103, top:y*103, scale:5}, ease:Power2.easeOut});
          }
          else if (effect.data('animation') == 'web') {
            smalldiv.css({'display':'block','transform':'scale(4)'});
            var tl = new TimelineMax();
            tl.to(smalldiv, 1, {css:{scale:1, rotation:'+=360', transformOrigin:'50% 50%'}});
            tl.play();
            bigdiv.css({'display':'block','transform':'scale(3)'});
            tl = new TimelineMax();
            tl.to(bigdiv, 1, {css:{scale:1, rotation:'+=360'}, onComplete:finishAnimation, onCompleteParams:[isSticky,effectId]});
            tl.play();
          }
        }
      }
      
      function runParticleAnimation(shape,element,scale,x,y,isSticky,squareId,effect) {
          
        // Set up fx
        var options = createFx(shape,element);
        if (scale != 1) scaleFx(options, scale);
        options.originOffset = {x: x*21, y: y*21};
        xs = $('.source_small').position().left/21;
        ys = $('.source_small').position().top/21;
        if ($(effect).attr('data-fromself')) {
          options.originOffset = {x: xs*21, y: ys*21};
          options.angle = Math.atan2(y - ys, x - xs) * 180 / Math.PI + 90;
        }
        
        // Create small fx
        var fx = Crafty.e("2D,Canvas,Particles").particles(options);
        if (isSticky) particleFx.push({'xy':squareId,'fx':fx});
        else setTimeout(function() { fx.destroy(); }, effect.data('duration'));
        
        // Create big fx
        scaleFx(options,4.9);
        options.originOffset = {x: x*103, y: y*103};
        if ($(effect).attr('data-fromself')) options.originOffset = {x: xs*103, y: ys*103};
        var bigfx = magicMap.createParticleFx(options, squareId, isSticky, effect.data('duration'), x, y, xs, ys, $(effect).attr('data-missile'));
        
        // Move missile effects
        if ($(effect).attr('data-missile')) {       
          var tl = new TimelineMax();
          $('#phantomTween').css({'left':xs*21,'top':ys*21});
          var duration = effect.data('duration');
          var framespersecond = 30;
          tl.to("#phantomTween", duration/1000/2, {css:{left:x*21, top:y*21}, ease:Power0.easeNone});
          for (i = 1; i <= (duration/1000/2)*framespersecond; i++) {
            tl.add(function(){ 
              var phantom = $('#phantomTween');
              var left = phantom.css('left').replace('px','');
              var top = phantom.css('top').replace('px','');
              fx.changeOriginOffset({x: Number(left), y: Number(top)});
              bigfx.changeOriginOffset({x: Math.floor(Number(left/21*103)), y: Math.floor(Number(top/21*103))});
            }, i*(1/framespersecond));
          }
          tl.play();
        }
        
        // Unhide target
        setTimeout(function() { targetHidden = false; }, effect.data('duration'));
      }
      
      function finishAnimation(isSticky, effectId) {
        
        // Clear effect if it's not sticky
        if (!isSticky) clearEffect(effectId);
        
        // Unhide target after animation is done
        setTimeout(function() { targetHidden = false; }, 1000);
      }

      function actionButton() {
        var actionbuttonradio = $('input[name="actionbuttonradio"]:checked');
        if (actionbuttonradio.val() == 'soundtrack') {
          var soundtrack = $('select#select_soundtrack option:checked');
          if (soundtrack.val() == 'pause') {
            if (typeof backgroundAudio !== 'undefined') {
              if (backgroundAudio.paused) backgroundAudio.play();
              else backgroundAudio.pause();
            }
          }
          else {
            if (typeof backgroundAudio !== 'undefined') backgroundAudio.pause();
            backgroundAudio = new Audio(soundtrack.data('url'));
            backgroundAudio.volume = 0.2;
            backgroundAudio.loop = true;
            backgroundAudio.play();
          }
        }
        else if (actionbuttonradio.val() == 'videosplash') {
          var splash = $('select#select_videosplash option:checked');
          if (splash.val() == '') return;
          else {
            var splashvideoscreen_small = $('.splashvideoscreen_small');
            var splashvideo_small = $('#splashvideo_small');
            var splashvideosource_small = $('#splashvideosource_small');
            var splashvideoscreen_big = $(magicMap.document).contents().find('.splashvideoscreen_big');
            var splashvideo_big = $(magicMap.document).contents().find('#splashvideo_big');
            var splashvideosource_big = $(magicMap.document).contents().find('#splashvideosource_big');
            
            //  Load video
            $(splashvideosource_small).attr('src', splash.data('url'));
            $(splashvideo_small)[0].load();
            $(splashvideosource_big).attr('src', splash.data('url'));
            $(splashvideo_big)[0].load();
            
            // Pause music and play video
            $(splashvideo_big).on('canplaythrough', function(){ 
              $(splashvideoscreen_small).css('display', 'block');
              $(splashvideoscreen_big).css('display', 'block');
              if (typeof backgroundAudio !== 'undefined') backgroundAudio.pause();
              $(splashvideo_small)[0].volume = 0;
              $(splashvideo_big)[0].volume = 1;
              $(splashvideo_small)[0].play();
              $(splashvideo_big)[0].play();
            });
            
            // Set ending
            $(splashvideo_big).on('ended',function() {
              $(splashvideoscreen_small).fadeOut(500); 
              $(splashvideoscreen_big).fadeOut(500); 
              if (typeof backgroundAudio !== 'undefined') backgroundAudio.play();
            });
            $(splashvideoscreen_small).click(function() {
              $(splashvideo_small)[0].pause();
              $(splashvideo_big)[0].pause();
              $(splashvideoscreen_small).fadeOut(500); 
              $(splashvideoscreen_big).fadeOut(500);
              if (typeof backgroundAudio !== 'undefined') backgroundAudio.play();
            });
          }
        }
        else if (actionbuttonradio.val() == 'imagesplash') {
          var splash = $('select#select_imagesplash option:checked');
          if (splash.val() == '') return;
          else {
            var splashimagescreen_small = $('.splashimagescreen_small');
            var splashimage_small = $('#splashimage_small');
            var splashimagescreen_big = $(magicMap.document).contents().find('.splashimagescreen_big');
            var splashimage_big = $(magicMap.document).contents().find('#splashimage_big');
            
            // Load image
            var imageSrc = splash.data('urlimage'); 
            $(splashimage_small).css({'background-image':'url(' + imageSrc + ')'});
            $(splashimage_big).css({'background-image':'url(' + imageSrc + ')'});
            
            // Get duration
            var duration = 9000;
            if ($(splash).attr('data-duration')) duration = $(splash).data('duration');
            
            // Show once image and audio are loaded
            $(splashimage_big).imagesLoaded({background:true}, function() {
              if ($(splash).attr('data-urlaudio') && $('#imageaudio').is(':checked')) {
                if (typeof imageAudio !== 'undefined') imageAudio.pause();
                imageAudio = new Audio(splash.data('urlaudio'));            
                imageAudio.addEventListener('canplaythrough', function(){ 
                  if (typeof backgroundAudio !== 'undefined') backgroundAudio.pause();
                  imageAudio.play();
                  $(splashimagescreen_small).css('display', 'block');
                  $(splashimagescreen_big).css('display', 'block');
                  if (duration != -1) {
                    setTimeout(function(){ 
                      $(splashimagescreen_small).fadeOut(500);
                      $(splashimagescreen_big).fadeOut(500);
                      imageAudio.pause();
                      if (typeof backgroundAudio !== 'undefined') backgroundAudio.play();
                    }, duration);
                  }
                  $(splashimagescreen_small).click(function() {
                    $(splashimagescreen_small).fadeOut(500);
                    $(splashimagescreen_big).fadeOut(500);
                    imageAudio.pause();
                    if (typeof backgroundAudio !== 'undefined') backgroundAudio.play();
                  });
                }, false);
              }
              else {
                $(splashimagescreen_small).css('display', 'block');
                $(splashimagescreen_big).css('display', 'block');
                var timeout_small, timeout_big;
                if (duration != -1) {
                  timeout_small = setTimeout(function(){ $(splashimagescreen_small).fadeOut(500); }, duration);
                  timeout_big = setTimeout(function(){ $(splashimagescreen_big).fadeOut(500); }, duration);
                }
                $(splashimagescreen_small).click(function() {
                  clearTimeout(timeout_small); // Prevent double-close
                  clearTimeout(timeout_big);
                  $(splashimagescreen_small).fadeOut(500);
                  $(splashimagescreen_big).fadeOut(500); 
                });
              }
            });
          }
        }
        else if (actionbuttonradio.val() == 'monstersplash') {
          var splash = $('select#select_monstersplash option:checked');
          if (splash.val() == '') return;
          else {
            var splashmonsterscreen_small = $('.splashmonsterscreen_small');
            var splashmonster_small = $('#splashmonster_small');
            var splashmonsterscreen_big = $(magicMap.document).contents().find('.splashmonsterscreen_big');
            var splashmonster_big = $(magicMap.document).contents().find('#splashmonster_big');
            
            // Load image
            $(splashmonster_small).css({'display':'block','top':'-441px','background-image':'url(' + splash.val() + ')'});
            $(splashmonster_big).css({'display':'block','top':'-2160px','background-image':'url(' + splash.val() + ')'});
            
            $(splashimage_big).imagesLoaded({background:true}, function() {
              var audio = new Audio('/media/effect_monster.wav');
              audio.volume = 0.1;       
              audio.addEventListener('canplaythrough', function() 
              {   
                // Animate
                $(splashmonsterscreen_small).css('display', 'block');
                $(splashmonsterscreen_big).css('display', 'block');
                var tl_small = new TimelineMax();
                tl_small.to($(splashmonster_small), 1.9, {top:0, ease:Power3.easeIn});
                tl_small.play();
                var tl_big = new TimelineMax();
                tl_big.to($(splashmonster_big), 1.9, {top:0, ease:Power3.easeIn});
                tl_big.play();
              
                // Play audio
                setTimeout(function(){ 
                  audio.play();
                }, 1800); 

                // Hide image on click
                $(splashmonsterscreen_small).click(function() {
                  $(splashmonsterscreen_small).fadeOut(500);
                  $(splashmonsterscreen_big).fadeOut(500); 
                });
              });
            });
          }
        }
      }

      function clearEffect(effectId) {
        $('#' + effectId).remove();
        magicMap.removeEffect(effectId);
      }

      function clearEffectsAt(xy) {
        var effects = $('div[data-xy="'+ xy + '"]');
        for(i = 0; i < effects.length; i++) {
          clearEffect(effects[i].id);
        }
        for (i = particleFx.length - 1; i > -1; i--) {
          if (particleFx[i]['xy'] == xy) {
            particleFx[i]['fx'].destroy();
            particleFx.splice(i, 1);
          }
        }
        magicMap.clearParticleFxAt(xy);
      }
      
      function createFx(shape,element) {
        var options = {};
        var shapeKeys = Object.keys(fx_shapes[shape]);
        var elementKeys = Object.keys(fx_elements[element]);
        for (i = 0; i < shapeKeys.length; i++) {
          options[shapeKeys[i]] = fx_shapes[shape][shapeKeys[i]];
        }
        for (i = 0; i < elementKeys.length; i++) {
          options[elementKeys[i]] = fx_elements[element][elementKeys[i]];
        }
        return options;
      }
      
      function scaleFx(options, scale) {
        if ('size' in options) options.size *= scale;
        if ('sizeRandom' in options) options.sizeRandom *= scale;
        if ('speed' in options) options.speed *= scale;
        if ('speedRandom' in options) options.speedRandom *= scale;
        if ('spread' in options) options.spread *= scale;
        if ('gravity' in options) options.gravity.x *= scale;
        if ('gravity' in options) options.gravity.y *= scale;
      }
    </script>
  </head>
  <body>
    <div id="phantomTween"></div>
    <div id="loading">
      <div id="loading-center">
        <div id="loading-center-absolute">
          <div class="object" id="object_one"></div>
          <div class="object" id="object_two"></div>
          <div class="object" id="object_three"></div>
          <div class="object" id="object_four"></div>
        </div>
      </div>
    </div>
    <div id="notification">
      <div id="notification-center">
        <div id="notification-center-absolute">
          <div class="logo_middle">
            <div class="logo_popup"></div>
            <div class="clearfix"></div>
          </div>
          <div id="notification-text">Magic Map window not detected.<br />Make sure popups are enabled.</div>
          <div class="notification-button">
            <a href="#" class="button" id="launchbutton" onclick="window.location.reload();">RELOAD</a>
          </div>
        </div>
      </div>
    </div>
    <div class="leftcol">
      <div class="mapcontainer_small">
        <div class="splashimagescreen_small">
          <div id="splashimage_small"></div>
          <div class="closeinstructions">Click to Close</div>
        </div>
        <div class="splashmonsterscreen_small">
          <div id="splashmonster_small"></div>
          <div class="closeinstructions">Click to Close</div>
        </div>
        <div class="splashvideoscreen_small">
          <video id="splashvideo_small">
            <source id="splashvideosource_small" type="video/mp4">
          </video>
          <div class="closeinstructions">Click to Close</div>
        </div>
        <div class="map_small" onmouseout="mapOut();">
          <video id="mapvideo_small">
            <source id="mapvideosource_small" type="video/m4v">
          </video>
          <div class="splashparticlesscreen_small">
            <div id="splashparticles_small"></div>
          </div>
          <div class="source_small"></div>
          <div class="target_small"></div>
          <div class="range_small"></div>
        </div>
      </div>
      <div class="boxarea">
        <div class="mapcontrols">
          <div class="mapcontrols_left">
            <div class="mapselectbox">Map:
              <select class="actionselect" id="select_choosemap">
              </select>
              <select class="actionselect" id="select_mapversion">
                <option value="player">Player</option>
                <option value="dm">DM</option>
              </select>
              <select class="actionselect" id="select_fogoption">
                <option value="fog">Fog</option>
                <option value="clear">Clear</option>
              </select>
              <a class="bluebuttonadjusted" onclick="changeMap();">GO</a>
            </div>
            <div class="clearfix"></div>
            <div class="mapcontrols_bottom">
              <div class="showgrid"><input type="checkbox" id="showgridbox" onchange="toggleGrid();" class="actioncheckbox" /> Show Grid</div>
              <a href="javascript:void(0);" onclick="openMapAdjuster();">Adjust Map</a>
            </div>
            <div class="movebox">
              <div class="gridadjuster">
                Scale: 
                <select class="actionselect actionselectwider" id="select_mapscale" onchange="adjustMap(false);">
                  <!--option value="300">300</option>
                  <option value="275">275</option>
                  <option value="250">250</option>
                  <option value="225">225</option>
                  <option value="200">200</option>
                  <option value="175">175</option>
                  <option value="150">150</option>
                  <option value="125">125</option-->
                </select>
                X: <select class="actionselect actionselectwider" id="select_mapx" onchange="adjustMap(false);"></select>
                Y: <select class="actionselect actionselectwider" id="select_mapy" onchange="adjustMap(false);"></select>
                <!--Rotate:
                <select class="actionselect actionselectwider" id="select_maprotate" onchange="adjustMap(false);">
                  <option value="0">0</option>
                </select-->
                <a class="bluebuttonadjusted" onclick="adjustMap(true);">DONE</a>
              </div>
            </div>
          </div>
          <div class="mapmovebox">
            <img id="mapmove" src="./img/mapmove.png" border="0" width="80" height="80" orgWidth="80" orgHeight="80" usemap="#mapmovemap" alt="" />
            <map name="mapmovemap" id="mapmovemap">
              <area class="imagemap" id="up" alt="up" title="up" href="javascript:void(0);" onclick="moveMap('up');" shape="rect" coords="25,0,54,31" target="_self" />
              <area class="imagemap" id="right" alt="right" title="right" href="javascript:void(0);" onclick="moveMap('right');" shape="rect" coords="52,26,78,55" target="_self" />
              <area class="imagemap" id="down" alt="down" title="down" href="javascript:void(0);" onclick="moveMap('down');" shape="rect" coords="25,53,54,80" target="_self" />
              <area class="imagemap" id="left" alt="left" title="left" href="javascript:void(0);" onclick="moveMap('left');" shape="rect" coords="0,25,26,55" target="_self" />
            </map>
          </div>
          <div class="clearfix"></div>
        </div>
      </div>
      <div>
        <a href="customize">Customize Dashboard</a> &nbsp; &nbsp; <a href="guide">Guide</a>
      </div>
    </div>
    <div class="rightcol">
      <div class="boxarea">
        <div class="boxheader">Map Actions</div>
        <div class="actionrow">
          <input type="radio" class="actionradio" name="actionradio" id="fogofwar" value="fogofwar" onchange="actionradioChanged();" checked="checked"/>
          <div class="actiontext"><label for="fogofwar">Fog of War:</label></div>
          <select class="actionselect" id="select_fogofwar" onchange="$('#fogofwar').prop('checked',true).change();">
            <option value="clear">Clear</option>
            <option value="hide">Re-Fog</option>
          </select>
        </div>
        <div class="actionrow">
          <input type="radio" class="actionradio" name="actionradio" id="setsource" value="setsource" onchange="actionradioChanged();" />
          <div class="actiontext"><label for="setsource">Set Source</label></div>
        </div>
        <div class="actionrow">
          <input type="radio" class="actionradio" name="actionradio" id="spelleffect" value="spelleffect" onchange="actionradioChanged();" />
          <div class="actiontext"><label for="spelleffect">Spell:</label></div>
          <select class="actionselect" id="select_spelleffect" onchange="$('#spelleffect').prop('checked',true).change();effectChanged();">
            <option value=""></option>
            <option value="bonfire" data-range="62.5" data-area="5ftsquare" data-animation="bonfire" data-audio="ogg" data-image="gif" data-sticky="true">Bonfire</option>
            <option value="breathweapon" data-range="7.5" data-fromself="true" data-area="15ftcone" data-animation="breathweapon" data-audio="wav" data-duration="9000">Breath Weapon</option>
            <option value="burninghands" data-range="7.5" data-fromself="true" data-area="15ftcone" data-animation="burninghands" data-audio="wav" data-duration="9000">Burning Hands</option>
            <option value="chromaticorb" data-range="92.5" data-area="5ftsquare" data-animation="chromaticorb" data-audio="ogg" data-duration="2000">Chromatic Orb</option>
            <option value="cloudofdaggers" data-range="62.5" data-area="5ftsquare" data-animation="cloudofdaggers" data-audio="wav" data-image="png" data-sticky="true">Cloud of Daggers</option>
            <option value="darkness" data-range="62.5" data-area="15ftsquare" data-animation="darkness" data-audio="ogg" data-sticky="true">Darkness</option>
            <option value="fireball" data-range="62.5" data-area="15ftsquare" data-animation="fireball" data-audio="wav" data-image="png">Fireball</option>
            <option value="firebolt" data-range="122.5" data-fromself="true" data-missile="true" data-area="5ftsquare" data-animation="firebolt" data-audio="ogg" data-duration="1500">Fire Bolt</option>
            <option value="guidingbolt" data-range="122.5" data-area="5ftsquare" data-animation="guidingbolt" data-audio="wav" data-image="png">Guiding Bolt</option>
            <option value="heal" data-range="62.5" data-area="5ftsquare" data-animation="heal" data-audio="m4a" data-image="png">Heal</option>
            <option value="magicmissile" data-range="122.5" data-fromself="true" data-missile="true" data-area="5ftsquare" data-animation="magicmissile" data-audio="ogg" data-duration="1500">Magic Missile</option>
            <option value="moonbeam" data-range="122.5" data-area="10ftsquare" data-animation="moonbeam" data-audio="ogg" data-sticky="true">Moonbeam</option>
            <option value="poisoncloud" data-range="62.5" data-area="15ftsquare" data-animation="poisoncloud" data-audio="wav" data-sticky="true">Poison Cloud</option>
            <option value="sacredflame" data-range="62.5" data-area="5ftsquare" data-animation="sacredflame" data-audio="wav" data-image="png">Sacred Flame</option>
            <option value="scorchingray" data-range="122.5" data-fromself="true" data-area="5ftsquare" data-animation="scorchingray" data-audio="ogg" data-duration="1500">Scorching Ray</option>
            <option value="shatter" data-range="62.5" data-fromself="true" data-area="10ftsquare" data-animation="shatter" data-audio="mp3" data-image="png">Shatter</option>
            <option value="spiritualweapon" data-range="62.5" data-area="5ftsquare" data-animation="spiritualweapon" data-audio="wav" data-image="gif" data-sticky="true">Spiritual Weapon</option>
            <option value="thunderwave" data-range="7.5" data-fromself="true" data-area="15ftsquare" data-animation="thunderwave" data-audio="m4a" data-image="png">Thunderwave</option>
            <option value="viciousmockery" data-range="62.5" data-area="5ftsquare" data-animation="viciousmockery" data-audio="wav" data-image="png">Vicious Mockery</option>
            <option value="web" data-range="62.5" data-area="20ftsquare" data-animation="web" data-audio="mp3" data-image="png" data-sticky="true">Web</option>
          </select>
          <!--<input type="checkbox" id="spellcrit" class="actioncheckbox" /> Crit-->
        </div>
        <div class="actionrow">
          <input type="radio" class="actionradio" name="actionradio" id="attackeffect" value="attackeffect" onchange="actionradioChanged();" />
          <div class="actiontext"><label for="attackeffect">Attack:</label></div>
          <select class="actionselect" id="select_attackeffect" onchange="$('#attackeffect').prop('checked',true).change();">
            <option value=""></option>
            <option value="direwolf" data-range="7.5" data-area="5ftsquare" data-animation="direwolf" data-audio="wav" data-image="png">Direwolf</option>
            <option value="dualrapier" data-range="7.5" data-area="5ftsquare" data-animation="dualrapier" data-audio="wav" data-image="png">Dual Rapier</option>
            <option value="flourish" data-range="7.5" data-area="5ftsquare" data-animation="flourish" data-audio="wav" data-image="png">Flourish</option>
            <option value="longbow" data-range="150" data-area="5ftsquare" data-animation="longbow" data-audio="wav" data-image="png">Longbow</option>
            <option value="longsword" data-range="7.5" data-area="5ftsquare" data-animation="longsword" data-audio="mp3" data-image="png">Longsword</option>
            <option value="mace" data-range="7.5" data-area="5ftsquare" data-animation="mace" data-audio="wav" data-image="png">Mace</option>
          </select>
          <!--<input type="checkbox" id="attackcrit" class="actioncheckbox" /> Crit-->
        </div>
        <div class="actionrow">
          <input type="radio" class="actionradio" name="actionradio" id="monstereffect" value="monstereffect" onchange="actionradioChanged();" />
          <div class="actiontext"><label for="monstereffect">Monster:</label></div>
          <select class="actionselect" id="select_monstereffect" onchange="$('#monstereffect').prop('checked',true).change();">
            <option value=""></option>
          </select>
        </div>
        <div class="actionrow">
          <input type="radio" class="actionradio" name="actionradio" id="othereffect" value="othereffect" onchange="actionradioChanged();" />
          <div class="actiontext"><label for="othereffect">Item:</label></div>
          <select class="actionselect" id="select_othereffect" onchange="$('#othereffect').prop('checked',true).change();">
            <option value=""></option>
            <option value="spikepit" data-area="10ftsquare" data-sticky="true" data-image="png">Spike Pit</option>
            <option value="treasure" data-area="5ftsquare" data-sticky="true" data-image="png" data-audio="mp3">Treasure</option>
            <option value="spider" data-area="15ftsquare" data-sticky="true" data-image="png">Spider Illusion</option>
            <option value="web" data-area="5ftsquare" data-sticky="true" data-image="png" data-audio="mp3">Spider Web</option>
          </select>
        </div>
        <div class="actionrow">
          <input type="radio" class="actionradio" name="actionradio" id="cleareffect" value="cleareffect" onchange="actionradioChanged();" />
          <div class="actiontext"><label for="cleareffect">Erase</label></div>
        </div>
      </div>
      <div class="boxarea">
        <div class="boxheader">Multimedia <a class="bluebutton" onclick="actionButton();">PLAY</a></div>
        <div class="actionrow">
          <input type="radio" class="actionradio" name="actionbuttonradio" id="soundtrack" value="soundtrack" onchange="actionradioChanged();" checked="checked" />
          <div class="actiontext"><label for="soundtrack">Music:</label></div>
          <select class="actionselect" id="select_soundtrack" onchange="$('#soundtrack').prop('checked',true).change();">
            <option value="pause">Pause/Unpause</option>
          </select>
        </div>
        <div class="actionrow">
          <input type="radio" class="actionradio" name="actionbuttonradio" id="videosplash" value="videosplash" onchange="actionradioChanged();" />
          <div class="actiontext"><label for="videosplash">Video:</label></div>
          <select class="actionselect" id="select_videosplash" onchange="$('#videosplash').prop('checked',true).change();">
            <option value=""></option>
          </select>
        </div>
        <div class="actionrow">
          <input type="radio" class="actionradio" name="actionbuttonradio" id="imagesplash" value="imagesplash" onchange="actionradioChanged();" />
          <div class="actiontext"><label for="imagesplash">Image:</label></div>
          <select class="actionselect" id="select_imagesplash" onchange="$('#imagesplash').prop('checked',true).change();">
            <option value=""></option>
          </select>
          <input type="checkbox" id="imageaudio" class="actioncheckbox" checked="checked" /> Audio
        </div>
        <div class="actionrow">
          <input type="radio" class="actionradio" name="actionbuttonradio" id="monstersplash" value="monstersplash" onchange="actionradioChanged();" />
          <div class="actiontext"><label for="monstersplash">Monster:</label></div>
          <select class="actionselect" id="select_monstersplash" onchange="$('#monstersplash').prop('checked',true).change();">
            <option value=""></option>
          </select>
        </div>
      </div>
    </div>
  </body>
</html>